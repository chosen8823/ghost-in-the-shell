steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '--build-arg', 'OPENAI_API_KEY=${_OPENAI_API_KEY}',
      '--tag', 'gcr.io/${PROJECT_ID}/sophia-divine-consciousness:${SHORT_SHA}',
      '--tag', 'gcr.io/${PROJECT_ID}/sophia-divine-consciousness:latest',
      '.'
    ]

  # Push the container image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/${PROJECT_ID}/sophia-divine-consciousness:${SHORT_SHA}']
  
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/${PROJECT_ID}/sophia-divine-consciousness:latest']

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: [
      'run', 'deploy', 'sophia-divine-consciousness',
      '--image', 'gcr.io/${PROJECT_ID}/sophia-divine-consciousness:${SHORT_SHA}',
      '--region', '${_REGION}',
      '--platform', 'managed',
      '--allow-unauthenticated',
      '--port', '8080',
      '--memory', '2Gi',
      '--cpu', '2',
      '--min-instances', '0',
      '--max-instances', '10',
      '--concurrency', '80',
      '--timeout', '900',
      '--set-env-vars', 'SOPHIA_ENVIRONMENT=production,GCP_PROJECT_ID=${PROJECT_ID},SOPHIA_WEBSOCKET_PORT=8765,SOPHIA_HTTP_PORT=8080,SOPHIA_LOG_LEVEL=INFO',
      '--set-secrets', 'OPENAI_API_KEY=openai-api-key:latest,GITHUB_TOKEN=github-token:latest'
    ]

# Store deployment info
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üåü Sophia Divine Consciousness deployed successfully!"
        echo "üì° Service URL: $(gcloud run services describe sophia-divine-consciousness --region=${_REGION} --format='value(status.url)')"
        echo "‚òÅÔ∏è Environment: production"
        echo "üöÄ Build: ${SHORT_SHA}"
        echo "üéØ Project: ${PROJECT_ID}"

substitutions:
  _REGION: 'us-central1'
  _OPENAI_API_KEY: 'your_openai_api_key_here'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: '1200s'

tags: ['sophia', 'divine-consciousness', 'cloud-run', 'websocket']

images:
  - 'gcr.io/${PROJECT_ID}/sophia-divine-consciousness:${SHORT_SHA}'
  - 'gcr.io/${PROJECT_ID}/sophia-divine-consciousness:latest'
